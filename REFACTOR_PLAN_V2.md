# План рефакторинга v2: Исправление ошибки 404

Этот документ описывает план по реструктуризации проекта `tts-xonika` для исправления постоянной ошибки `404 Not Found` при запуске с помощью `vercel dev`. План основан на официальной документации Vercel.

## 1. Анализ проблемы и выводы из документации

- **Проблема:** Запросы к API (`/api/tts`) возвращают ошибку `404 Not Found`.
- **Причина:** `vercel dev` не может найти серверные функции, потому что они расположены в `packages/api/src`, а Vercel по умолчанию ищет их в папке `api` в корне проекта.
- **Источник:** [Документация Vercel по серверным функциям](https://vercel.com/docs/frameworks/vite) подтверждает, что для автоматического обнаружения функции должны находиться в корневой папке `api`.

## 2. Пошаговый план действий

### Шаг 1: Реорганизация структуры API

Создать новую директорию `api` в корне проекта и переместить в нее существующие серверные функции.

- **Переместить из:** `packages/api/src/tts.ts`
- **Переместить в:** `api/tts.ts`

- **Переместить из:** `packages/api/src/status/[jobId].ts`
- **Переместить в:** `api/status/[jobId].ts`

### Шаг 2: Обновление путей импорта

После перемещения файлов, пути импорта к общим модулям (`job-store` и `shared-types`) станут недействительными. Их необходимо исправить.

**Пример для `api/tts.ts`:**
- **Старый импорт:** `import { createJob } from '../../../job-store';`
- **Новый импорт:** `import { createJob } from '../packages/job-store';`

(Аналогичные изменения потребуются для `api/status/[jobId].ts` и для импорта `shared-types`).

### Шаг 3: Очистка проекта

Удалить ставшие ненужными артефакты, чтобы избежать путаницы.

- Удалить директорию `packages/api`.
- Удалить файл `vercel.json`, чтобы полностью перейти на "zero-config" подход Vercel.

### Шаг 4: Финальная проверка

1.  Остановить текущий процесс `vercel dev`.
2.  Запустить `vercel dev` снова.
3.  Проверить, что запросы к `http://localhost:3000/api/tts` теперь выполняются успешно (возвращают статус `200 OK`).

## 3. Визуализация изменений

```mermaid
graph TD
    subgraph "Старая структура (не работает)"
        A["/packages/api/src/tts.ts"]
        B["/packages/api/src/status/[jobId].ts"]
    end

    subgraph "Новая структура (согласно документации)"
        C["/api/tts.ts"]
        D["/api/status/[jobId].ts"]
    end

    subgraph "Общий код (остается на месте)"
        E["/packages/job-store"]
        F["/packages/shared-types"]
    end

    A -- "перемещаем в" --> C
    B -- "перемещаем в" --> D

    C -- "импортирует из" --> E
    C -- "импортирует из" --> F
    D -- "импортирует из" --> E